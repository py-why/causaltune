<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>causaltune.optimiser &mdash; CausalTune 2022 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CausalTune
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebook_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../causaltune.html">Public Module Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CausalTune</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">causaltune.optimiser</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for causaltune.optimiser</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">_base</span>
<span class="kn">from</span> <span class="nn">flaml</span> <span class="kn">import</span> <span class="n">tune</span>

<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">dowhy</span> <span class="kn">import</span> <span class="n">CausalModel</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_identifier</span> <span class="kn">import</span> <span class="n">IdentifiedEstimand</span>

<span class="kn">from</span> <span class="nn">econml.inference</span> <span class="kn">import</span> <span class="n">BootstrapInference</span>

<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="kn">from</span> <span class="nn">causaltune.params</span> <span class="kn">import</span> <span class="n">SimpleParamService</span>
<span class="kn">from</span> <span class="nn">causaltune.scoring</span> <span class="kn">import</span> <span class="n">Scorer</span>
<span class="kn">from</span> <span class="nn">causaltune.r_score</span> <span class="kn">import</span> <span class="n">RScoreWrapper</span>
<span class="kn">from</span> <span class="nn">causaltune.utils</span> <span class="kn">import</span> <span class="n">clean_config</span><span class="p">,</span> <span class="n">treatment_is_multivalue</span>
<span class="kn">from</span> <span class="nn">causaltune.models.monkey_patches</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AutoML</span><span class="p">,</span>
    <span class="n">apply_multitreatment</span><span class="p">,</span>
    <span class="n">effect_stderr</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">causaltune.data_utils</span> <span class="kn">import</span> <span class="n">CausalityDataset</span>
<span class="kn">from</span> <span class="nn">causaltune.models.passthrough</span> <span class="kn">import</span> <span class="n">feature_filter</span>


<span class="c1"># Patched from sklearn.linear_model._base to adjust rtol and atol values</span>
<span class="k">def</span> <span class="nf">_check_precomputed_gram_matrix</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">precompute</span><span class="p">,</span> <span class="n">X_offset</span><span class="p">,</span> <span class="n">X_scale</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-2</span>
<span class="p">):</span>
    <span class="n">n_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">n_features</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">f1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">f1</span><span class="p">]</span> <span class="o">-</span> <span class="n">X_offset</span><span class="p">[</span><span class="n">f1</span><span class="p">])</span> <span class="o">*</span> <span class="n">X_scale</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">f2</span><span class="p">]</span> <span class="o">-</span> <span class="n">X_offset</span><span class="p">[</span><span class="n">f2</span><span class="p">])</span> <span class="o">*</span> <span class="n">X_scale</span><span class="p">[</span><span class="n">f2</span><span class="p">]</span>

    <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">precompute</span><span class="p">[</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Gram matrix passed in via &#39;precompute&#39; parameter &quot;</span>
            <span class="s2">&quot;did not pass validation when a single element was &quot;</span>
            <span class="s2">&quot;checked - please check that it was computed &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;properly. For element (</span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s2">) we computed &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> but the user-supplied value was &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>


<span class="n">_base</span><span class="o">.</span><span class="n">_check_precomputed_gram_matrix</span> <span class="o">=</span> <span class="n">_check_precomputed_gram_matrix</span>


<div class="viewcode-block" id="CausalTune"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune">[docs]</a><span class="k">class</span> <span class="nc">CausalTune</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs AutoML to find best EconML estimator.</span>
<span class="sd">    Optimises hyperparams of component models of each estimator</span>
<span class="sd">    and hyperparams of the estimators themselves. Uses the ERUPT</span>
<span class="sd">    metric for estimator selection.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: shell</span>

<span class="sd">        cd = CausalityDataset(data=df, treatment=&#39;T&#39;, outcomes=[&#39;Y&#39;])</span>
<span class="sd">        cd.preprocess_dataset()</span>

<span class="sd">        estimator_list = [&quot;.LinearDML&quot;,&quot;LinearDRLearner&quot;,&quot;metalearners&quot;]</span>
<span class="sd">        ct = CausalTune(time_budget=10, estimator_list=estimator_list)</span>

<span class="sd">        ct.fit(cd)</span>

<span class="sd">        print(f&quot;Best estimator: {ct.best_estimator}&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;energy_distance&quot;</span><span class="p">,</span>
        <span class="n">metrics_to_report</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time_budget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">use_ray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">estimator_list</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">propensity_model</span><span class="o">=</span><span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
        <span class="n">outcome_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">components_task</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span>
        <span class="n">components_verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">components_pred_time_limit</span><span class="o">=</span><span class="mi">10</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span>
        <span class="n">components_njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">components_time_budget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">try_init_configs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">resources_per_trial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include_experimental_estimators</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">store_all_estimators</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_df (pandas.DataFrame): dataset to perform causal inference on</span>
<span class="sd">            metric (str): metric to optimise.</span>
<span class="sd">                Defaults to &quot;erupt&quot; for CATE, &quot;energy_distance&quot; for IV</span>
<span class="sd">            metrics_to_report (list): additional metrics to compute and report.</span>
<span class="sd">                Defaults to [&quot;qini&quot;,&quot;auc&quot;,&quot;ate&quot;,&quot;erupt&quot;, &quot;norm_erupt&quot;] for CATE</span>
<span class="sd">                or [&quot;energy_distance&quot;] for IV</span>
<span class="sd">            time_budget (float): a number of the time budget in seconds. -1 if no limit.</span>
<span class="sd">            num_samples (int): max number of iterations.</span>
<span class="sd">            verbose (int):  controls verbosity, higher means more messages. range (0,3). Defaults to 0.</span>
<span class="sd">            use_ray (bool): use Ray backend (requires ray to be installed).</span>
<span class="sd">            estimator_list (list): a list of strings for estimator names,</span>
<span class="sd">             or &quot;auto&quot; for a recommended subset, &quot;all&quot; for all, or a list of substrings of estimator names</span>
<span class="sd">               e.g. ```[&#39;dml&#39;, &#39;CausalForest&#39;]```</span>
<span class="sd">            train_size (float): Fraction of data used for training set. Defaults to 0.8.</span>
<span class="sd">            test_size (float): Optional size of test dataset. Defaults to None.</span>
<span class="sd">            propensity_model (Union[str, Any]): &#39;dummy&#39; for dummy classifier, &#39;auto&#39; for AutoML, or an</span>
<span class="sd">                sklearn-style classifier</span>
<span class="sd">            components_task (str): task for component models. Defaults to &quot;regression&quot;.</span>
<span class="sd">            components_verbose (int): verbosity of component model HPO (hyper parameter optimisation).</span>
<span class="sd">                range (0,3). Defaults to 0.</span>
<span class="sd">            components_pred_time_limit (float): prediction time limit for component models</span>
<span class="sd">            components_njobs (int): number of concurrent jobs for component model optimisation.</span>
<span class="sd">                Defaults to -1 (all available cores).</span>
<span class="sd">            components_time_budget (float): time budget for HPO of component models in seconds.</span>
<span class="sd">                Defaults to overall time budget / 2.</span>
<span class="sd">            try_init_configs (bool): try list of good performing estimators before continuing with HPO.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            resources_per_trial: computational resources per trial, defaults in constructor to {&quot;cpu&quot;: 0.5}</span>
<span class="sd">            include_experimental_estimators (bool): Include experimental causal estimators. Whether an estimator</span>
<span class="sd">                is experimental can be seen in SimpleParamsService in scoring.py</span>
<span class="sd">            store_all_estimators (Optional[bool]). store estimator objects for interim trials. Defaults to False</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">time_budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">components_time_budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Either time_budget or components_time_budget must be specified&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget_s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_budget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span>
            <span class="s2">&quot;use_ray&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">use_ray</span>  <span class="c1"># requires ray to be installed via pip install flaml[ray]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;resources_per_trial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">resources_per_trial</span> <span class="k">if</span> <span class="n">resources_per_trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;try_init_configs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">try_init_configs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span>
            <span class="s2">&quot;include_experimental_estimators&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">include_experimental_estimators</span>

        <span class="c1"># params for FLAML on component models:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;task&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">components_task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">components_verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span>
            <span class="s2">&quot;pred_time_limit&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">components_pred_time_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;n_jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">components_njobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">components_time_budget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;eval_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;holdout&quot;</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">train_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">component_test_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">train_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: convert train_size to fraction based on data size, in fit()</span>
            <span class="n">component_test_size</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;split_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_test_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;train_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;store_all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">store_all_estimators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;metrics_to_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_to_report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;propensity_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">propensity_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;outcome_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outcome_model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_estimators</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">original_estimator_list</span> <span class="o">=</span> <span class="n">estimator_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">causal_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identified_estimand</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># properties that are used to resume fits (warm start)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_cfg</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CausalTune.get_params"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="CausalTune.get_estimators"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.get_estimators">[docs]</a>    <span class="k">def</span> <span class="nf">get_estimators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="CausalTune.init_propensity_model"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.init_propensity_model">[docs]</a>    <span class="k">def</span> <span class="nf">init_propensity_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propensity_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># user can choose between flaml and dummy for propensity model.</span>
        <span class="k">if</span> <span class="n">propensity_model</span> <span class="o">==</span> <span class="s2">&quot;dummy&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propensity_model</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;prior&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">propensity_model</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propensity_model</span> <span class="o">=</span> <span class="n">AutoML</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">],</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;classification&quot;</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">propensity_model</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="n">propensity_model</span><span class="p">,</span> <span class="s2">&quot;predict_proba&quot;</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propensity_model</span> <span class="o">=</span> <span class="n">propensity_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;propensity_model valid values are &quot;dummy&quot;, &quot;auto&quot;, or a classifier object&#39;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CausalTune.init_outcome_model"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.init_outcome_model">[docs]</a>    <span class="k">def</span> <span class="nf">init_outcome_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcome_model</span><span class="p">):</span>
        <span class="c1"># if we are only supplying certain features to the propensity function,</span>
        <span class="c1"># make them invisible to the outcome component model</span>
        <span class="c1"># This is a workaround for the DoWhy/EconML data model which doesn&#39;t</span>
        <span class="c1"># support that out of the box</span>
        <span class="k">if</span> <span class="n">outcome_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: implement filtering like below, when there are propensity-only features</span>
            <span class="c1"># feature_filter below acts on classes not instances</span>
            <span class="c1"># to preserve all the extra methods through inheritance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outcome_model</span> <span class="o">=</span> <span class="n">outcome_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
            <span class="n">propensity_only_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">p</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">propensity_modifiers</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">common_causes</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">effect_modifiers</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">propensity_only_cols</span><span class="p">):</span>
                <span class="n">outcome_model_class</span> <span class="o">=</span> <span class="n">feature_filter</span><span class="p">(</span>
                    <span class="n">AutoML</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">effect_modifiers</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">common_causes</span><span class="p">,</span> <span class="n">first_cols</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outcome_model_class</span> <span class="o">=</span> <span class="n">AutoML</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outcome_model</span> <span class="o">=</span> <span class="n">outcome_model_class</span><span class="p">(</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">]</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CausalTune.fit"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">CausalityDataset</span><span class="p">],</span>
        <span class="n">treatment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">outcome</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">common_causes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">effect_modifiers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">instruments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">propensity_modifiers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">estimator_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resume</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">time_budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs AutoML on list of causal inference estimators</span>
<span class="sd">        - If estimator has a search space specified in its parameters, HPO is performed on the whole model.</span>
<span class="sd">        - Otherwise, only its component models are optimised</span>

<span class="sd">        Args:</span>
<span class="sd">            data (pandas.DataFrame): dataset for causal inference</span>
<span class="sd">            treatment (str): name of treatment variable</span>
<span class="sd">            outcome (str): name of outcome variable</span>
<span class="sd">            common_causes (List[str]): list of names of common causes</span>
<span class="sd">            effect_modifiers (List[str]): list of names of effect modifiers</span>
<span class="sd">            instruments (List[str]): list of names of instrumental variables</span>
<span class="sd">            propensity_modifiers (List[str]): list of names of propensity modifiers</span>
<span class="sd">            estimator_list (Optional[Union[str, List[str]]]): subset of estimators to consider</span>
<span class="sd">            resume (Optional[bool]): set to True to continue previous fit</span>
<span class="sd">            time_budget (Optional[int]): change new time budget allocated to fit, useful for warm starts.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outcome</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CausalityDataset</span><span class="p">):</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CausalityDataset</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">CausalityDataset</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">treatment</span><span class="p">,</span>
                <span class="n">outcome</span><span class="p">,</span>
                <span class="n">common_causes</span><span class="o">=</span><span class="n">common_causes</span><span class="p">,</span>
                <span class="n">effect_modifiers</span><span class="o">=</span><span class="n">effect_modifiers</span><span class="p">,</span>
                <span class="n">instruments</span><span class="o">=</span><span class="n">instruments</span><span class="p">,</span>
                <span class="n">propensity_modifiers</span><span class="o">=</span><span class="n">propensity_modifiers</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">treatment_values</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">treatment_values</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">treatment_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;Treatment must take at least 2 values, eg 0 and 1!&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_control_value</span> <span class="o">=</span> <span class="n">treatment_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">treatment_values</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># To be used for component model training/selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;train_size&quot;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># smuggle propensity modifiers into common causes, filter later in component models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">causal_model</span> <span class="o">=</span> <span class="n">CausalModel</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">outcome</span><span class="o">=</span><span class="n">outcome</span><span class="p">,</span>
            <span class="n">common_causes</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">common_causes</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">propensity_modifiers</span><span class="p">,</span>
            <span class="n">effect_modifiers</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">,</span>
            <span class="n">instruments</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">instruments</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_propensity_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;propensity_model&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_outcome_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;outcome_model&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identified_estimand</span><span class="p">:</span> <span class="n">IdentifiedEstimand</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">causal_model</span><span class="o">.</span><span class="n">identify_effect</span><span class="p">(</span><span class="n">proceed_when_unidentifiable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identified_estimand</span><span class="o">.</span><span class="n">estimands</span><span class="p">[</span><span class="s2">&quot;iv&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">instruments</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="s2">&quot;iv&quot;</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identified_estimand</span><span class="o">.</span><span class="n">estimands</span><span class="p">[</span><span class="s2">&quot;backdoor&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="s2">&quot;backdoor&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t identify the kind of problem from &quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identified_estimand</span><span class="o">.</span><span class="n">estimands</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># This must be stateful because we need to train the treatment propensity function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="n">Scorer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">causal_model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propensity_model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
            <span class="n">treatment_is_multivalue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_treatment_values</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">resolve_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_to_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">resolve_reported_metrics</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;metrics_to_report&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;energy_distance&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_best_estimators</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># TODO: allow specifying an exclusion list, too</span>
        <span class="n">used_estimator_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_estimator_list</span> <span class="k">if</span> <span class="n">estimator_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">estimator_list</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">used_estimator_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">used_estimator_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">&quot;estimator_list must either be a str or an iterable of str&quot;</span>

        <span class="c1"># config with method-specific params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">SimpleParamService</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propensity_model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outcome_model</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;n_jobs&quot;</span><span class="p">],</span>
            <span class="n">include_experimental</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;include_experimental_estimators&quot;</span><span class="p">],</span>
            <span class="n">multivalue</span><span class="o">=</span><span class="n">treatment_is_multivalue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_treatment_values</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">estimator_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">estimator_names_from_patterns</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
            <span class="n">used_estimator_list</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No valid estimators in </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">used_estimator_list</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;available estimators: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">estimator_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">time_budget</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget_s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_budget</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span>
                <span class="s2">&quot;time_budget_s&quot;</span>
            <span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget_s&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget_s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">2.5</span>
                <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_list</span><span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">cmtb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;component_models&quot;</span><span class="p">][</span><span class="s2">&quot;time_budget&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cmtb</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Component model time budget is </span><span class="si">{</span><span class="n">cmtb</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Recommended value is at least 300 for smallish datasets, 1800 for datasets with&gt; 100K rows&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;test_size&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r_scorer</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;r_scorer&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_to_report</span>
            <span class="k">else</span> <span class="n">RScoreWrapper</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outcome_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propensity_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span>
                <span class="n">outcome</span><span class="p">,</span>
                <span class="n">treatment</span><span class="p">,</span>
                <span class="n">common_causes</span><span class="p">,</span>
                <span class="n">effect_modifiers</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">search_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">search_space</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_list</span><span class="p">)</span>
        <span class="n">init_cfg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_configs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;try_init_configs&quot;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">resume</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="c1"># pull out configs and resume_scores from previous trials:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_cfg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">])</span>
            <span class="c1"># append init_cfgs that have not yet been evaluated</span>
            <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">init_cfg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_cfg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span> <span class="k">if</span> <span class="n">cfg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_cfg</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tune_with_config</span><span class="p">,</span>
            <span class="n">search_space</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">points_to_evaluate</span><span class="o">=</span><span class="n">init_cfg</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resume_cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_cfg</span><span class="p">,</span>
            <span class="n">evaluated_rewards</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resume_scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_scores</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;energy_distance&quot;</span> <span class="k">else</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="n">low_cost_partial_config</span><span class="o">=</span><span class="p">{},</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tuner&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get_best_trial</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Optimization failed! Did you set large enough time_budget and components_budget?&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_summary_scores</span><span class="p">()</span></div>

<div class="viewcode-block" id="CausalTune.update_summary_scores"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.update_summary_scores">[docs]</a>    <span class="k">def</span> <span class="nf">update_summary_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores scores for metric of interest for each estimator</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">Scorer</span><span class="o">.</span><span class="n">best_score_by_estimator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span>
        <span class="c1"># now inject the separately saved model objects</span>
        <span class="k">for</span> <span class="n">est_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="c1"># Todo: Check approximate scores for OrthoIV (possibly other IV estimators)</span>
            <span class="c1"># assert (</span>
            <span class="c1">#     self._best_estimators[est_name][0] == self.scores[est_name][self.metric]</span>
            <span class="c1"># ), &quot;Can&#39;t match best model to score&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">est_name</span><span class="p">][</span><span class="s2">&quot;estimator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_estimators</span><span class="p">[</span><span class="n">est_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_tune_with_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs Hyperparameter Optimisation for a</span>
<span class="sd">        causal inference estimator</span>

<span class="sd">        Args:</span>
<span class="sd">            config (dict): dictionary with search space for</span>
<span class="sd">                all tunable parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            (dict): values of metrics after optimisation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># estimate effect with current config</span>

        <span class="c1"># if using FLAML &lt; 1.0.7 need to set n_jobs = 2 here</span>
        <span class="c1"># to spawn a separate process to prevent cross-talk between tuner and automl on component models:</span>

        <span class="n">estimates</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;threading&quot;</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_effect</span><span class="p">)(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;estimator&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># pop and cache separately the fitted model object, so we only store the best ones per estimator</span>
        <span class="k">if</span> <span class="s2">&quot;exception&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">estimates</span><span class="p">:</span>
            <span class="n">est_name</span> <span class="o">=</span> <span class="n">estimates</span><span class="p">[</span><span class="s2">&quot;estimator_name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_best_estimators</span><span class="p">[</span><span class="n">est_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">estimates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;energy_distance&quot;</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_estimators</span><span class="p">[</span><span class="n">est_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">estimates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;store_all&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_best_estimators</span><span class="p">[</span><span class="n">est_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">estimates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">],</span>
                        <span class="n">estimates</span><span class="p">[</span><span class="s2">&quot;estimator&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_best_estimators</span><span class="p">[</span><span class="n">est_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">estimates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">],</span>
                        <span class="n">estimates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;estimator&quot;</span><span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">estimates</span>

    <span class="k">def</span> <span class="nf">_est_effect_stub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_params</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">causal_model</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identified_estimand</span><span class="p">,</span>
            <span class="n">method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span>
            <span class="n">control_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_value</span><span class="p">,</span>
            <span class="n">treatment_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_treatment_values</span><span class="p">,</span>
            <span class="n">target_units</span><span class="o">=</span><span class="s2">&quot;ate&quot;</span><span class="p">,</span>  <span class="c1"># condition used for CATE</span>
            <span class="n">confidence_intervals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">method_params</span><span class="o">=</span><span class="n">method_params</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_estimate_effect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;estimates effect with chosen estimator&quot;&quot;&quot;</span>

        <span class="c1"># add params that are tuned by flaml:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">clean_config</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;estimator_name&quot;</span><span class="p">)</span>
        <span class="c1"># params_to_tune = {</span>
        <span class="c1">#     k: v for k, v in config.items() if (not k == &quot;estimator_name&quot;)</span>
        <span class="c1"># }</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">method_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">)</span>
        <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;init_params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">init_params</span><span class="p">},</span>
            <span class="s2">&quot;fit_params&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1">#</span>
            <span class="c1"># if True:  #</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_est_effect_stub</span><span class="p">(</span><span class="n">method_params</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;estimator_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_metrics</span><span class="p">(</span>
                    <span class="n">estimate</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_metrics</span><span class="p">(</span>
                    <span class="n">estimate</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">],</span>
                <span class="s2">&quot;estimator&quot;</span><span class="p">:</span> <span class="n">estimate</span><span class="p">,</span>
                <span class="s2">&quot;estimator_name&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;estimator_name&quot;</span><span class="p">),</span>
                <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluation failed!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                <span class="s2">&quot;estimator_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_name</span><span class="p">,</span>
                <span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span>
                <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_compute_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">make_scores</span><span class="p">(</span>
            <span class="n">estimator</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_to_report</span><span class="p">,</span> <span class="n">r_scorer</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CausalTune.score_dataset"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.score_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">score_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After fitting, generate scores for an additional dataset, add them to the scores dict.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): input dataframe</span>
<span class="sd">            dataset_name (str): dictionary key</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">scr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">scr</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">][</span><span class="n">dataset_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_metrics</span><span class="p">(</span><span class="n">scr</span><span class="p">[</span><span class="s2">&quot;estimator&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A string indicating the best estimator found</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">best_result</span><span class="p">[</span><span class="s2">&quot;estimator_name&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the *trained* best estimator</span>

<span class="sd">        @return CausalEstimator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">best_result</span><span class="p">[</span><span class="s2">&quot;estimator&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">estimator</span>

<div class="viewcode-block" id="CausalTune.best_model_for_estimator"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.best_model_for_estimator">[docs]</a>    <span class="k">def</span> <span class="nf">best_model_for_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the best model found for a particular estimator.</span>
<span class="sd">        estimator: self.tune_results[estimator].best_config</span>

<span class="sd">        Args:</span>
<span class="sd">            estimator_name (str): the estimator&#39;s name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (dowhy.causal_estimator.CausalEstimate): the best model for estimator_name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note that this returns the trained Econml estimator, whose attributes include</span>
        <span class="c1"># fitted  models for E[T | X, W], for E[Y | X, W], CATE model, etc.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">estimator_name</span><span class="p">][</span><span class="s2">&quot;estimator&quot;</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (dict): the best configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">best_config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_config_per_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (dict): all estimators&#39; best configuration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_score_per_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A dictionary of all estimators&#39; best score.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (float):  the best score found.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">best_result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">]</span>

<div class="viewcode-block" id="CausalTune.effect"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.effect">[docs]</a>    <span class="k">def</span> <span class="nf">effect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Heterogeneous Treatment Effects for data df</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): data to predict treatment effect for</span>

<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray): predicted treatment effect for each datapoint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CausalTune.effect_inference"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.effect_inference">[docs]</a>    <span class="k">def</span> <span class="nf">effect_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inference (uncertainty) results produced by best estimator</span>
<span class="sd">        Only implemented for EconML estimators so far</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): data to run inference on</span>
<span class="sd">            args: passed through to underlying estimator</span>
<span class="sd">            kwargs: passed through to underlying estimator</span>

<span class="sd">        Returns:</span>
<span class="sd">            (from EconML: NormalInferenceResults):</span>
<span class="sd">            EconML results object for inference assuming a normal distribution.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;Econml&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
            <span class="c1"># Get a list of &quot;Inference&quot; objects from EconML, one per treatment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">apply_multitreatment</span> <span class="o">=</span> <span class="n">apply_multitreatment</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">_configs</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimator</span><span class="p">]</span><span class="o">.</span><span class="n">inference</span> <span class="o">==</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Can&#39;t calculate stds for estimator </span><span class="se">\</span>
<span class="s2">                </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimator</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                as boostrap inference is not supported yet&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">effect_inference</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;No pointwise error estimates for non-EconML estimators implemented yet&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CausalTune.effect_stderr"><a class="viewcode-back" href="../../causaltune.html#causaltune.optimiser.CausalTune.effect_stderr">[docs]</a>    <span class="k">def</span> <span class="nf">effect_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">n_bootstrap_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute standard errors for best causal estimator</span>
<span class="sd">            Currently implemented for EconML estimators.</span>
<span class="sd">            Computes analytical standard errors if available and boostraps otherwise.</span>
<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): data to run inference on</span>
<span class="sd">            n_bootstrap_samples (int, optional): number of runs if standard errors are boostrapped. Defaults to 5.</span>
<span class="sd">            n_jobs (int, optional): Number of bootstrap estimates to run in parallel. Defaults to 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray): standard error for each data point from df</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;Econml&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)):</span>
            <span class="c1"># Get a list of &quot;Inference&quot; objects from EconML, one per treatment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">effect_stderr</span> <span class="o">=</span> <span class="n">effect_stderr</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">method_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_estimator</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">inference</span> <span class="o">==</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">:</span>
                <span class="c1"># TODO: before bootstrapping, check whether that&#39;s already been done</span>
                <span class="n">bootstrap</span> <span class="o">=</span> <span class="n">BootstrapInference</span><span class="p">(</span>
                    <span class="n">n_bootstrap_samples</span><span class="o">=</span><span class="n">n_bootstrap_samples</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span>
                <span class="p">)</span>

                <span class="n">best_cfg</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;estimator&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;init_params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">best_cfg</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="o">.</span><span class="n">init_params</span><span class="p">},</span>
                    <span class="s2">&quot;fit_params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inference&quot;</span><span class="p">:</span> <span class="n">bootstrap</span><span class="p">},</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bootstrapped_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_est_effect_stub</span><span class="p">(</span><span class="n">method_params</span><span class="p">)</span>
                <span class="n">est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bootstrapped_estimate</span><span class="o">.</span><span class="n">estimator</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the estimator supports other inference methods,</span>
                <span class="c1"># those have already been included</span>
                <span class="n">est</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="k">return</span> <span class="n">est</span><span class="o">.</span><span class="n">effect_stderr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;No pointwise error estimates for non-EconML estimators implemented yet&quot;</span>
            <span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Wise Payments Limited, PyWhy Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>